<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>THINKBIG</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <style>
      .wrapper {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
        grid-template-rows: 200px 200px 200px 250px;
        grid-gap: 10px;
        margin-right: 15px;
        margin-left: 15px;
      }
      .item:nth-child(1) {
        grid-column-start: 1;
        grid-column-end: 4;
        grid-row-start: 1;
        grid-row-end: 2;
      }
      .item:nth-child(2) {
        grid-column-start: 1;
        grid-column-end: 4;
        grid-row-start: 1;
        grid-row-end: 2;
      }
      .item:nth-child(2) {
        grid-column-start: 1;
        grid-column-end: 4;
        grid-row-start: 2;
        grid-row-end: 4;
      }
      .item:nth-child(3) {
        grid-column-start: 1;
        grid-column-end: 4;
        grid-row-start: 4;
        grid-row-end: 5;
      }
      .item:nth-child(4) {
        grid-column-start: 4;
        grid-column-end: 6;
        grid-row-start: 1;
        grid-row-end: 3;
      }
      .item:nth-child(5) {
        grid-column-start: 4;
        grid-column-end: 6;
        grid-row-start: 3;
        grid-row-end: 5;
      }
      #navbar {
        border-radius: 25px;
        margin-top: 20px;
        text-align: center;
        border: 3px solid black;
        margin-left: 10px;
        margin-right: 10px;
      }
      .bold {
        padding-top: 25px;
        font-size: 20px;
        color: black;
      }
      .ta1 {
        margin-top: 13px;
      }
    </style>
  </head>
  <body>
    <!--woongjin_boys-->
    <nav class="navbar navbar-expand-lg navbar-flame bg-flame">
      <span style="font: italic bold 1.5em/1em Georgia, serif">
        <a class="navbar-brand" href="#!" style="color: black">Woonjin_boys</a>
      </span>
    </nav>
    <div class="wrapper">
      <!--첫번째 칸 __ 참여자 얼굴-->
      <div
        class="item"
        style="
          border: 5px double black;
          border-radius: 10px;
          text-align: center;
        "
      >
        <img
          style="
            border-radius: 10px;
            margin: 5px;
            border: 3px solid black;
            margin-right: 5px;
          "
          src="{{ url_for('video_feed', peer='1') }}"
          width="23%"
          height="90%"
        />
        <img
          style="border-radius: 10px; margin: 5px; border: 3px solid black"
          src="{{ url_for('video_feed', peer='2') }}"
          width="23%"
          height="90%"
        />
        <img
          style="border-radius: 10px; margin: 5px; border: 3px solid black"
          src="{{ url_for('video_feed', peer='3') }}"
          width="23%"
          height="90%"
        />
        <img
          style="border-radius: 10px; margin: 5px; border: 3px solid black"
          src="{{ url_for('video_feed', peer='4') }}"
          width="23%"
          height="90%"
        />
        <br />
      </div>

      <!--두번째 칸 __ 발화자 얼굴-->
      <div class="item" style="border: 3px solid black; border-radius: 10px">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
          <div class="container-fluid">
            <a class="navbar-brand" href="#"><strong>발화자</strong></a>
          </div>
        </nav>
        <div style="text-align: center">
          <img
            style="
              border: 5px double black;
              border-radius: 10px;
              margin: 5px;
              margin-top: 10px;
            "
            src="{{ url_for('video_feed', peer='1') }}"
            width="50%"
            height="80%"
          />
        </div>
      </div>

      <!--세번째 칸 __ 발화 기록-->
      <div class="item" style="border: 3px solid black; border-radius: 10px">
        <nav class="navbar sticky-top navbar-dark bg-dark">
          <div class="container-fluid">
            <a class="navbar-brand" href="#"
              ><strong>학생들의 발화 기록</strong></a
            >
            <form
              action="http://localhost:5000/mfccend"
              method="POST"
              target="_blank"
            >
              <input
                type="submit"
                name="button"
                class="btn btn-success"
                style="background-color: rgb(211, 62, 8)"
                value="Refresh"
              />
            </form>
          </div>
        </nav>
        <div id="SpeakingRate1" class="ta1">
          <strong>성효제</strong> 발화율 : 0%, 발화 횟수 0회
        </div>
        <div id="SpeakingRate2" class="ta1">
          <strong>이관우</strong> 발화율 : 0%, 발화 횟수 0회
        </div>
        <div id="SpeakingRate3" class="ta1">
          <strong>이진영</strong> 발화율 : 0%, 발화 횟수 0회
        </div>
        <div id="SpeakingRate4" class="ta1">
          <strong>최시열</strong> 발화율 : 0%, 발화 횟수 0회
        </div>
        <script>
          setInterval(function () {
            $.ajax({
              url: "/mfcc_feed",
              type: "POST",
              success: function (response) {
                console.log("first response : ");
                console.log(response["SpeakingRate1"]);

                if (response["speakingRate1"] !== "0") {
                  $("#SpeakingRate1").html(
                    "<strong> 성효제 </strong> 발화율 : " +
                      response["SpeakingRate1"] +
                      "%, 발화 횟수 " +
                      response["SpeakingCount1"] +
                      "회" +
                      "<img width = '100px' src = {{url_for('fig1')}}>" +
                      "</br>"
                  );
                }
                if (response["SpeakingRate2"] !== "0") {
                  $("#SpeakingRate2").html(
                    "<strong> 이관우 </strong> 발화율 : " +
                      response["SpeakingRate2"] +
                      "%, 발화 횟수" +
                      response["SpeakingCount2"] +
                      "회" +
                      "<img width = '100px' src = {{url_for('fig2')}}>" +
                      "</br>"
                  );
                }
                if (response["SpeakingRate3"] !== "0") {
                  $("#SpeakingRate3").html(
                    "<strong> 이진영 </strong> 발화율 : " +
                      response["SpeakingRate3"] +
                      "%, 발화 횟수" +
                      response["SpeakingCount3"] +
                      "회" +
                      "<img width = '100px' src = {{url_for('fig3')}}>" +
                      "</br>"
                  );
                }
                if (response["SpeakingRate4"] !== "0") {
                  $("#SpeakingRate4").html(
                    "<strong> 최시열 </strong> 발화율 : " +
                      response["SpeakingRate4"] +
                      "%, 발화 횟수" +
                      response["SpeakingCount4"] +
                      "회" +
                      "<img width = '100px' src = {{url_for('fig4')}}>" +
                      "</br>"
                  );
                }
              },
              error: function (error) {
                console.log(error);
              },
            });
          }, 1000);
        </script>
      </div>

      <!--네번째 칸 __ 내 얼굴-->
      <div class="item" style="border-radius: 10px; border: 3px solid black">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
          <div class="container-fluid">
            <a class="navbar-brand" href="#"><strong>내 얼굴</strong></a>
          </div>
        </nav>
        <div style="text-align: center">
          <img
            style="
              border: 5px double black;
              border-radius: 10px;
              margin-top: 20px;
            "
            src="{{ url_for('justWebCAM_feed') }}"
            width="72%"
            height="84%"
          />
        </div>
      </div>

      <!--다섯번째 칸 학생들의 행동 기록-->
      <div
        class="item"
        style="
          overflow-x: hidden;
          width: 100%;
          height: 100%;
          border-radius: 10px;
          border: 3px solid black;
        "
      >
        <nav class="navbar sticky-top navbar-white bg-white">
          <div class="container-fluid">
            <div class="container" style="border-radius: 5px; width: 100%">
              <div class="row" style="border-radius: 5px; height: 30%">
                <div class="col" style="border: 3px double black">
                  <p
                    id="student1"
                    style="padding: 0px; font-size: 15px; text-align: center"
                  ></p>
                </div>
                <div class="col" style="border: 3px double black">
                  <p
                    id="student2"
                    style="padding: 0px; font-size: 15px; text-align: center"
                  ></p>
                </div>
              </div>
              <div class="row" style="border-radius: 5px; height: 30%">
                <div class="col" style="border: 3px double black">
                  <p
                    id="student3"
                    style="padding: 0px; font-size: 15px; text-align: center"
                  ></p>
                </div>
                <div class="col" style="border: 3px double black">
                  <p
                    id="student4"
                    style="padding: 0px; font-size: 15px; text-align: center"
                  ></p>
                </div>
              </div>
            </div>
          </div>
        </nav>

        <!-- 학생들 행동 기록 -> 나중에 동적 생성으로 수정해야한다. -->

        <div id="record"></div>

        <script>
          var body = document.getElementById("record");
          var student_1 = document.getElementById("student1");
          var student_2 = document.getElementById("student2");
          var student_3 = document.getElementById("student3");
          var student_4 = document.getElementById("student4");

          let arr,
            startTime,
            endTime,
            behaviorType,
            overlap = "None",
            behavior_setting;
          /*!!! 전부다 동적 생성으로 바꿔야 함 !!!*/
          //모든 이상 행동 종합
          let action = [0, 0, 0, 0];
          //눈 감음
          let behavior_1 = [0, 0, 0, 0];
          //고개 기울임
          let behavior_2 = [0, 0, 0, 0];
          //얼굴 멀어짐
          let behavior_3 = [0, 0, 0, 0];
          //이상 행동 시간
          let behavior_time = [0, 0, 0, 0];
          var student_name = "?";
          setInterval(function () {
            $.ajax({
              url: "/log_feed",
              type: "POST",
              success: function (response) {
                console.log(response);
                console.log("test : " + response["behaviorType"]);

                if (response["name"] === "1") {
                  if (response["behaviorType"] === "0") {
                    behavior_1[0]++;
                  } else if (response["behaviorType"] === "1") {
                    behavior_2[0]++;
                  } else {
                    behavior_3[0]++;
                  }
                  action[0]++;
                  student_name = "성효제";
                  behavior_time[0] +=
                    parseInt(response["endTime"]) -
                    parseInt(response["startTime"]);
                } else if (response["name"] === "2") {
                  if (response["behaviorType"] === "0") {
                    behavior_1[1]++;
                  } else if (response["behaviorType"] === "1") {
                    behavior_2[1]++;
                  } else {
                    behavior_3[1]++;
                  }
                  action[1]++;
                  student_name = "이관우";
                  behavior_time[1] +=
                    parseInt(response["endTime"]) -
                    parseInt(response["startTime"]);
                } else if (response["name"] === "3") {
                  if (response["behaviorType"] === "0") {
                    behavior_1[2]++;
                  } else if (response["behaviorType"] === "1") {
                    behavior_2[2]++;
                  } else {
                    behavior_3[2]++;
                  }
                  action[2]++;
                  student_name = "이진영";
                  behavior_time[2] +=
                    parseInt(response["endTime"]) -
                    parseInt(response["startTime"]);
                } else if (response["name"] === "4") {
                  if (response["behaviorType"] === "0") {
                    behavior_1[3]++;
                  } else if (response["behaviorType"] === "1") {
                    behavior_2[3]++;
                  } else {
                    behavior_3[3]++;
                  }
                  action[3]++;
                  student_name = "최시열";
                  behavior_time[3] +=
                    parseInt(response["endTime"]) -
                    parseInt(response["startTime"]);
                }
                $("#student1").html(
                  "<strong> 성효제 </strong> 학생" +
                    "</br>" +
                    "<strong>얼굴 멀어짐 </strong>:" +
                    behavior_3[0] +
                    "회, " +
                    "<strong>고개 기울임</strong>:" +
                    behavior_2[0] +
                    "회 </br>" +
                    "<strong>눈 감음 </strong>:" +
                    behavior_1[0] +
                    "회, " +
                    "<strong>이상 행동 시간</strong>:" +
                    behavior_time[0] +
                    "초"
                );

                $("#student2").html(
                  "<strong> 이관우 </strong> 학생" +
                    "</br>" +
                    "<strong>얼굴 멀어짐 </strong>:" +
                    behavior_3[1] +
                    "회, " +
                    "<strong>고개 기울임</strong>:" +
                    behavior_2[1] +
                    "회 </br>" +
                    "<strong>눈 감음 </strong>:" +
                    behavior_1[1] +
                    "회, " +
                    "<strong>이상 행동 시간</strong>:" +
                    behavior_time[1] +
                    "초"
                );

                $("#student3").html(
                  "<strong> 이진영 </strong> 학생" +
                    "</br>" +
                    "<strong>얼굴 멀어짐 </strong>:" +
                    behavior_3[2] +
                    "회, " +
                    "<strong>고개 기울임</strong>:" +
                    behavior_2[2] +
                    "회 </br>" +
                    "<strong>눈 감음 </strong>:" +
                    behavior_1[2] +
                    "회, " +
                    "<strong>이상 행동 시간</strong>:" +
                    behavior_time[2] +
                    "초"
                );

                $("#student4").html(
                  "<strong> 최시열 </strong> 학생" +
                    "</br>" +
                    "<strong>얼굴 멀어짐 </strong>:" +
                    behavior_3[3] +
                    "회, " +
                    "<strong>고개 기울임</strong>:" +
                    behavior_2[3] +
                    "회 </br>" +
                    "<strong>눈 감음 </strong>:" +
                    behavior_1[3] +
                    "회, " +
                    "<strong>이상 행동 시간</strong>:" +
                    behavior_time[3] +
                    "초"
                );
                if (
                  response["startTime"] !== "0" &&
                  response["startTime"] !== overlap
                ) {
                  //이상 행동 발생시 버튼 생성
                  var button = document.createElement("button");
                  //버튼 디자인
                  button.style.cssText =
                    "border-radius : 10px; background-color : white; width :100%; text-align : center ";
                  //behaviorType 결정
                  behaviorType = response["behaviorType"];
                  if (behaviorType === "0") {
                    behavior_setting = "눈 감음";
                  } else if (behaviorType === "1") {
                    behavior_setting = "고개 기울임";
                  } else {
                    behavior_setting = "얼굴 멀어짐";
                  }
                  //행동 유지 시간 소수점 제거 -> 나중에 수정해야한다.
                  var starttime = response["startTime"].slice(0, 3);
                  var endtime = response["endTime"].slice(0, 3);

                  //버튼 생성
                  button.innerHTML =
                    "<strong>" +
                    student_name +
                    "</strong>" +
                    " 학생의 " +
                    starttime +
                    "초 부터 " +
                    endtime +
                    "초 까지 " +
                    "<br/>" +
                    "<strong>" +
                    behavior_setting +
                    "</strong>" +
                    " 감지됨";
                  body.appendChild(button);

                  overlap = response["startTime"];
                }
              },
              error: function (error) {
                console.log(error);
              },
            });
          }, 1000);
        </script>
      </div>
    </div>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
