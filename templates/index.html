<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>THINKBIG</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
      integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
      crossorigin="anonymous"
    />
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
    <script src="//ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <style>
      .wrapper {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
        grid-template-rows: 200px 200px 200px 250px;
        grid-gap: 10px;
        margin-right: 15px;
        margin-left: 15px;
      }
      .item:nth-child(1) {
        grid-column-start: 1;
        grid-column-end: 4;
        grid-row-start: 1;
        grid-row-end: 2;
      }
      .item:nth-child(2) {
        grid-column-start: 1;
        grid-column-end: 4;
        grid-row-start: 1;
        grid-row-end: 2;
      }
      .item:nth-child(2) {
        grid-column-start: 1;
        grid-column-end: 4;
        grid-row-start: 2;
        grid-row-end: 4;
      }
      .item:nth-child(3) {
        grid-column-start: 1;
        grid-column-end: 4;
        grid-row-start: 4;
        grid-row-end: 5;
      }
      .item:nth-child(4) {
        grid-column-start: 4;
        grid-column-end: 6;
        grid-row-start: 1;
        grid-row-end: 3;
      }
      .item:nth-child(5) {
        grid-column-start: 4;
        grid-column-end: 6;
        grid-row-start: 3;
        grid-row-end: 5;
      }
      #navbar {
        border-radius: 25px;
        margin-top: 20px;
        text-align: center;
        border: 3px solid black;
        margin-left: 10px;
        margin-right: 10px;
      }
      .bold {
        padding-top: 25px;
        font-size: 20px;
        color: black;
      }
      .ta1 {
        margin-top: 13px;
      }
      .lb-wrap {
        width: 23%;
        height: 50%;
      }
      .lb-wrap img {
        width: 100%;
        vertical-align: middle;
      }
      .lb-text {
        margin-left: 40px;
        height: 20px;
        background-color: #fbfbfa;
        text-align: center;
        font-size: 15px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <!-- <audio src="/wav" style="display: none;" autoplay></audio> -->
    <!--woongjin_boys-->
    <div class="wrapper">
      <!--첫번째 칸 __ 참여자 얼굴-->
      <div
        class="item"
        style="
          border: 5px double black;
          border-radius: 10px;
          text-align: center;
        "
      >
        <div class="lb-wrap" style="float: left">
          <!--이미지 layout 사이즈-->
          <div class="lb-text" style="float: left">
            <!--텍스트 디자인-->
            <p>최시열</p>
          </div>
          <div class="lb-image" style="float: left">
            <img
              src="{{ url_for('video_feed', peer='1') }}"
              style="
                height: 160px;
                border-radius: 10px;
                margin: 5px;
                border: 3px solid black;
                margin-left: 35px;
                margin-right: 5px;
              "
              alt=""
            />
          </div>
        </div>
        <div class="lb-wrap" style="float: left; margin-left: 5px">
          <!--이미지 layout 사이즈-->
          <div class="lb-text" style="float: left">
            <!--텍스트 디자인-->
            <p>이관우</p>
          </div>
          <div class="lb-image" style="float: left">
            <img
              src="{{ url_for('video_feed', peer='2') }}"
              style="
                height: 160px;
                border-radius: 10px;
                margin: 5px;
                border: 3px solid black;
                margin-left: 35px;
                margin-right: 5px;
              "
              alt=""
            />
          </div>
        </div>
        <div class="lb-wrap" style="float: left; margin-left: 5px">
          <!--이미지 layout 사이즈-->
          <div class="lb-text" style="float: left">
            <!--텍스트 디자인-->
            <p>이진영</p>
          </div>
          <div class="lb-image" style="float: left">
            <img
              src="{{ url_for('video_feed', peer='3') }}"
              style="
                height: 160px;
                border-radius: 10px;
                margin: 5px;
                border: 3px solid black;
                margin-left: 35px;
                margin-right: 5px;
              "
              alt=""
            />
          </div>
        </div>
        <div class="lb-wrap" style="float: left; margin-left: 5px">
          <!--이미지 layout 사이즈-->
          <div class="lb-text" style="float: left">
            <!--텍스트 디자인-->
            <p>성효제</p>
          </div>
          <div class="lb-image" style="float: left">
            <img
              src="{{ url_for('video_feed', peer='4') }}"
              style="
                height: 160px;
                border-radius: 10px;
                margin: 5px;
                border: 3px solid black;
                margin-left: 35px;
                margin-right: 5px;
              "
              alt=""
            />
          </div>
        </div>
        <br />
      </div>

      <!--두번째 칸 __ 발화자 얼굴-->
      <div class="item" style="border: 3px solid black; border-radius: 10px">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
          <div class="container-fluid">
            <a class="navbar-brand" href="#"><strong>발화자</strong></a>
          </div>
        </nav>
        <div style="margin-left: 300px"><strong>최시열</strong></div>
        <div style="text-align: center">
          <img
            style="border: 5px double black; border-radius: 10px"
            src="{{ url_for('video_feed', peer='1') }}"
            width="50%"
            height="80%"
          />
        </div>
      </div>

      <!--세번째 칸 __ 발화 기록-->
      <div class="item" style="border: 3px solid black; border-radius: 10px">
        <nav class="navbar sticky-top navbar-dark bg-dark">
          <div class="container-fluid">
            <a class="navbar-brand" href="#"
              ><strong>발표 기록</strong></a
            >
            <form
              action="http://localhost:5000/mfccend"
              method="POST"
              target="_blank"
            >
              <input
                type="submit"
                name="button"
                class="btn btn-success"
                style="background-color: rgb(25, 247, 62)"
                value="새로고침"
              />
            </form>
          </div>
        </nav>
        <div style="overflow-x: hidden; width: 100%; height: 75%">
          <div
            id="SpeakingRate1"
            class="ta1"
          >
            <strong>최시열 : </strong> 발표 횟수 0회, 발표 시간 0초
          </div>
          <div
            id="SpeakingRate2"
            class="ta1"
          >
            <strong>이관우 : </strong> 발표 횟수 0회, 발표 시간 0초
          </div>
          <div
            id="SpeakingRate3"
            class="ta1"
          >
            <strong>이진영 : </strong> 발표 횟수 0회, 발표 시간 0초
          </div>
          <div
            id="SpeakingRate4"
            class="ta1"
          >
            <strong>성효제 : </strong> 발표 횟수 0회, 발표 시간 0초
          </div>
          <script>
            var speakImg1 = new Image(650,50);
            var speakingBoard1 = document.getElementById("SpeakingRate1");
            var speakImg2 = new Image(650,50);
            var speakingBoard2 = document.getElementById("SpeakingRate2");
            var speakImg3 = new Image(650,50);
            var speakingBoard3 = document.getElementById("SpeakingRate3");
            var speakImg4 = new Image(650,50);
            var speakingBoard4 = document.getElementById("SpeakingRate4");
            setInterval(function () {
              $.ajax({
                url: "/mfcc_feed",
                type: "POST",
                success: function (response) {
                  console.log("first response : ");
                  console.log(response["SpeakingRate1"]);

                  if (response["SpeakingRate1"] !== "0") {
                    speakImg1.src = '{{url_for('fig1')}}';
                    $("#SpeakingRate1").html(
                      "<strong> 최시열 : </strong> 발표 횟수 " +
                      response["SpeakingCount1"] +
                      "회, 발표 시간 " +
                      response["SpeakingRate1"] +
                      "초" + "   "
                    );
                    speakingBoard1.appendChild(speakImg1);
                  }
                  if (response["SpeakingRate2"] !== "0") {
                    speakImg2.src = '{{url_for('fig2')}}';
                    $("#SpeakingRate2").html(
                      "<strong> 이관우 : </strong> 발표 횟수 " +
                      response["SpeakingCount2"] +
                      "회, 발표 시간 " +
                      response["SpeakingRate2"] +
                      "초" + "   "
                    );
                    speakingBoard2.appendChild(speakImg2);
                  }
                  if (response["SpeakingRate3"] !== "0") {
                    speakImg3.src = '{{url_for('fig3')}}';
                    $("#SpeakingRate3").html(
                      "<strong> 이진영 : </strong> 발표 횟수 " +
                      response["SpeakingCount3"] +
                      "회, 발표 시간 " +
                      response["SpeakingRate3"] +
                      "초" + "   "
                    );
                    speakingBoard3.appendChild(speakImg3);
                  }
                  if (response["SpeakingRate4"] !== "0") {
                    speakImg4.src = '{{url_for('fig4')}}';
                    $("#SpeakingRate4").html(
                      "<strong> 성효제 : </strong> 발표 횟수 " +
                      response["SpeakingCount4"] +
                      "회, 발표 시간 " +
                      response["SpeakingRate4"] +
                      "초" + "   "
                    );
                    speakingBoard4.appendChild(speakImg4);
                  }
                },
                error: function (error) {
                  console.log(error);
                },
              });
            }, 1000);
          </script>
        </div>
      </div>

      <!--네번째 칸 __ 내 얼굴-->
      <div class="item" style="border-radius: 10px; border: 3px solid black">
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
          <div class="container-fluid">
            <a class="navbar-brand" href="#"><strong>내 얼굴</strong></a>
          </div>
        </nav>

        <div style="text-align: center">
          <img
            style="
              border: 5px double black;
              border-radius: 10px;
              margin-top: 20px;
            "
            src="{{ url_for('justWebCAM_feed') }}"
            width="72%"
            height="84%"
          />
        </div>
      </div>

      <!--다섯번째 칸 학생들의 행동 기록-->
      <div
        class="item"
        style="
          overflow: auto;
          width: 100%;
          height: 100%;
          border-radius: 10px;
          border: 3px solid black;
        "
      >
        <!-- <nav class="navbar sticky-top navbar-white bg-white">
          <div class="container-fluid">
            <div class="container" style="border-radius: 5px; width: 100%">
              <div class="row" style="border-radius: 5px; height: 30%">
                <div class="col" style="border: 3px double black">
                  <p
                    id="student1"
                    style="padding: 0px; font-size: 15px; text-align: center"
                  ></p>
                </div>
                <div class="col" style="border: 3px double black">
                  <p
                    id="student2"
                    style="padding: 0px; font-size: 15px; text-align: center"
                  ></p>
                </div>
              </div>
              <div class="row" style="border-radius: 5px; height: 30%">
                <div class="col" style="border: 3px double black">
                  <p
                    id="student3"
                    style="padding: 0px; font-size: 15px; text-align: center"
                  ></p>
                </div>
                <div class="col" style="border: 3px double black">
                  <p
                    id="student4"
                    style="padding: 0px; font-size: 15px; text-align: center"
                  ></p>
                </div>
              </div>
            </div>
          </div>
        </nav> -->

        <table bordercolor="black" width ="100%" height="60%" align = "center" >
          <tr bgcolor="blue" align ="center">
        <p><td colspan = "6" height="10%" span style="color:white">학생들 집중도 경고 기록</td></p>
          </tr>
          <tr height="18%" align = "center" bgcolor="lavender">
        <td width="15%" style="border-right: none;">학생</td>
        <td width="20%"><img src="https://i.ibb.co/jbHBS0v/sleep.jpg" alt="eye" border="0" height=100 width=100></img></td>
        <td width="20%"><img src="https://i.ibb.co/GktDbgd/head.jpg" alt="head" border="0" height=100 width=100></img></td>
        <td width="20%"><img src="https://i.ibb.co/sKKfK97/area.jpg" alt="area" border="0" height=100 width=100></img></td>
        <td width="15%">총 부주의 시간</th>
        <td width="10%"></td>
          </tr>
          <tr height="8%" align="center">
            <td><strong>최시열</strong></td>
        <td id="student1_0"></td>
        <td id="student1_1"></td>
        <td id="student1_2"></td>
        <td id="student1_3"></td>
        <td></td>
          </tr>
          <tr height="8%" align="center">
        <td><strong>이관우</strong></td>
        <td id="student2_0"></td>
        <td id="student2_1"></td>
        <td id="student2_2"></td>
        <td id="student2_3"></td>
        <td></td>
          </tr>
          <tr height="8%" align="center">
        <td><strong>이진영</strong></td>
        <td id="student3_0"></td>
        <td id="student3_1"></td>
        <td id="student3_2"></td>
        <td id="student3_3"></td>
        <td></td>
          </tr>
          <tr height="8%" align="center">
        <td><strong>성효제</strong></td>
        <td id="student4_0"></td>
        <td id="student4_1"></td>
        <td id="student4_2"></td>
        <td id="student4_3"></td>
        <td></td>
          </tr>
      </table>
        <!-- 학생들 행동 기록 -> 나중에 동적 생성으로 수정해야한다. -->

        <div id="record" class="logContainer"></div>

        <script>
          var body = document.getElementById("record");
          var student_1 = document.getElementById("student1");
          var student_2 = document.getElementById("student2");
          var student_3 = document.getElementById("student3");
          var student_4 = document.getElementById("student4");

          let arr,
            startTime,
            endTime,
            behaviorType,
            overlap = "None",
            behavior_setting;
          let isoverlap1 = "0";
          let isoverlap2 = "0";
          let isoverlap3 = "0";
          let isoverlap4 = "0";
          /*!!! 전부다 동적 생성으로 바꿔야 함 !!!*/
          //모든 이상 행동 종합
          let action = [0, 0, 0, 0];
          //눈 감음
          let eye = [0, 0, 0, 0];
          //고개 기울임
          let head = [0, 0, 0, 0];
          //얼굴 멀어짐
          let area = [0, 0, 0, 0];
          //이상 행동 시간
          let behavior_time = [0, 0, 0, 0];
          var student_name = "?";
          setInterval(function () {
            $.ajax({
              url: "/log_feed",
              type: "POST",
              success: function (response) {
                console.log(response);
                console.log("test : " + response["startTime"]);

                if (
                  response["name"] === "0" &&
                  isoverlap1 !== response["startTime"]
                ) {
                  if (response["behaviorType"] === "0") {
                    eye[0]++;
                  } else if (response["behaviorType"] === "1") {
                    head[0]++;
                  } else {
                    area[0]++;
                  }
                  isoverlap1 = response["startTime"];
                  action[0]++;
                  student_name = "최시열";
                  behavior_time[0] +=
                    parseInt(response["endTime"]) -
                    parseInt(response["startTime"]);
                } else if (
                  response["name"] === "1" &&
                  isoverlap2 !== response["startTime"]
                ) {
                  if (response["behaviorType"] === "0") {
                    eye[1]++;
                  } else if (response["behaviorType"] === "1") {
                    head[1]++;
                  } else {
                    area[1]++;
                  }
                  isoverlap2 = response["startTime"];
                  action[1]++;
                  student_name = "이관우";
                  behavior_time[1] +=
                    parseInt(response["endTime"]) -
                    parseInt(response["startTime"]);
                } else if (
                  response["name"] === "2" &&
                  isoverlap3 !== response["startTime"]
                ) {
                  if (response["behaviorType"] === "0") {
                    eye[2]++;
                  } else if (response["behaviorType"] === "1") {
                    head[2]++;
                  } else {
                    area[2]++;
                  }
                  isoverlap3 = response["startTime"];
                  action[2]++;
                  student_name = "이진영";
                  behavior_time[2] +=
                    parseInt(response["endTime"]) -
                    parseInt(response["startTime"]);
                } else if (
                  response["name"] === "3" &&
                  isoverlap4 !== response["startTime"]
                ) {
                  if (response["behaviorType"] === "0") {
                    eye[3]++;
                  } else if (response["behaviorType"] === "1") {
                    head[3]++;
                  } else {
                    area[3]++;
                  }
                  isoverlap4 = response["startTime"];
                  action[3]++;
                  student_name = "성효제";
                  behavior_time[3] +=
                    parseInt(response["endTime"]) -
                    parseInt(response["startTime"]);
                }
                $("#student1_0").html(
                  "<strong>" +
                    eye[0] +
                    "</strong>" +
                    "회"
                );
                $("#student1_1").html(
                  "<strong>" +
                    head[0] +
                    "</strong>" +
                    "회"
                );
                $("#student1_2").html(
                  "<strong>" +
                    area[0] +
                    "</strong>" +
                    "회"
                );
                $("#student1_3").html(
                  "<strong>" +
                    behavior_time[0] +
                    "</strong>" +
                    "초"
                );

                $("#student2_0").html(
                  "<strong>" +
                    eye[1] +
                    "</strong>" +
                    "회"
                );
                $("#student2_1").html(
                  "<strong>" +
                    head[1] +
                    "</strong>" +
                    "회"
                );
                $("#student2_2").html(
                  "<strong>" +
                    area[1] +
                    "</strong>" +
                    "회"
                );
                $("#student2_3").html(
                  "<strong>" +
                    behavior_time[1] +
                    "</strong>" +
                    "초"
                );

                $("#student3_0").html(
                  "<strong>" +
                    eye[2] +
                    "</strong>" +
                    "회"
                );
                $("#student3_1").html(
                  "<strong>" +
                    head[2] +
                    "</strong>" +
                    "회"
                );
                $("#student3_2").html(
                  "<strong>" +
                    area[2] +
                    "</strong>" +
                    "회"
                );
                $("#student3_3").html(
                  "<strong>" +
                    behavior_time[2] +
                    "</strong>" +
                    "초"
                );

                $("#student4_0").html(
                  "<strong>" +
                    eye[3] +
                    "</strong>" +
                    "회"
                );
                $("#student4_1").html(
                  "<strong>" +
                    head[3] +
                    "</strong>" +
                    "회"
                );
                $("#student4_2").html(
                  "<strong>" +
                    area[3] +
                    "</strong>" +
                    "회"
                );
                $("#student4_3").html(
                  "<strong>" +
                    behavior_time[3] +
                    "</strong>" +
                    "초"
                );

                // $("#student2").html(
                //   "<strong> 이관우 </strong> 학생" +
                //   "</br>" +
                //     "<strong>얼굴 멀어짐 </strong>:" +
                //     area[1] +
                //     "회, " +
                //     "<strong>고개 기울임</strong>:" +
                //     head[1] +
                //     "회 </br>" +
                //     "<strong>눈 감음 </strong>:" +
                //     eye[1] +
                //     "회, " +
                //     "<strong>이상 행동 시간</strong>:" +
                //     behavior_time[1] +
                //     "초"
                // );

                // $("#student3").html(
                //   "<strong> 이진영 </strong> 학생" +
                //   "</br>" +
                //     "<strong>얼굴 멀어짐 </strong>:" +
                //     area[2] +
                //     "회, " +
                //     "<strong>고개 기울임</strong>:" +
                //     head[2] +
                //     "회 </br>" +
                //     "<strong>눈 감음 </strong>:" +
                //     eye[2] +
                //     "회, " +
                //     "<strong>이상 행동 시간</strong>:" +
                //     behavior_time[2] +
                //     "초"
                // );

                // $("#student4").html(
                //   "<strong> 최시열 </strong> 학생" +
                //   "</br>" +
                //     "<strong>얼굴 멀어짐 </strong>:" +
                //     area[3] +
                //     "회, " +
                //     "<strong>고개 기울임</strong>:" +
                //     head[3] +
                //     "회 </br>" +
                //     "<strong>눈 감음 </strong>:" +
                //     eye[3] +
                //     "회, " +
                //     "<strong>이상 행동 시간</strong>:" +
                //     behavior_time[3] +
                //     "초"
                // );
                if (
                  response["startTime"] !== "0" &&
                  response["startTime"] !== overlap
                ) {
                  //이상 행동 발생시 버튼 생성
                  var button = document.createElement("button");
                  //버튼 디자인
                  button.style.cssText =
                    "border-radius : 10px; background-color : white; width :20%; height :180%; text-align : center ";
                  //behaviorType 결정
                  let imgSrcStr = ""
                  behaviorType = response["behaviorType"];
                  if (behaviorType === "0") {
                    behavior_setting = "눈 감음";
                    imgSrcStr = '<img src="https://i.ibb.co/jbHBS0v/sleep.jpg" alt="eye" border="0" height=75 width=75>'
                  } else if (behaviorType === "1") {
                    behavior_setting = "고개 기울임";
                    imgSrcStr = '<img src="https://i.ibb.co/GktDbgd/head.jpg" alt="head" border="0" height=75 width=75>'
                  } else {
                    behavior_setting = "얼굴 멀어짐";
                    imgSrcStr = '<img src="https://i.ibb.co/sKKfK97/area.jpg" alt="area" border="0" height=75 width=75>'
                  }
                  //행동 유지 시간 소수점 제거 -> 나중에 수정해야한다.
                  var starttime = response["startTime"].slice(0, 3);
                  var endtime = response["endTime"].slice(0, 3);
                  var timee = endtime - starttime;

                  //버튼 생성
                  button.innerHTML =
                  imgSrcStr +
                  "<br/>" +
                  "<br/>" +
                  "<strong>" +
                  student_name +
                  "</strong>" +
                  "<br/>" +
                  "<strong>" +
                  timee +
                  "초" +
                  "</strong>" +
                  "<br/>" +
                  "(" +
                    starttime +
                    " ~ " +
                    endtime +
                    ")" +
                    "<br/>" +
                    behavior_setting;
                  button.className = "logItem"
                  body.appendChild(button);
                  overlap = response["startTime"];
                }
              },
              error: function (error) {
                console.log(error);
              },
            });
          }, 1000);
        </script>
      </div>
    </div>
    <!-- Bootstrap core JS-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <style>
      .logContainer {
        display: flex;
        flex-wrap: nowrap;
        overflow-x: auto;
      }
      .logItem { flex: 0 0 auto; }
    </style>
  </body>
</html>
